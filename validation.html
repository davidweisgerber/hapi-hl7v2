<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 2023-10-30 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20231030" />
    <meta http-equiv="Content-Language" content="en" />
    <title>HAPI &#x2013; </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="https://hapifhir.github.io/hapi-hl7v2" id="bannerLeft"><img src="images/hapi_banner.png"  alt="HAPI"/></a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2023-10-30<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 2.5</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="http://www.uhn.ca/" class="externalLink" title="University Health Network">University Health Network</a></li>
      <li class="pull-right"><span class="divider">|</span>
<a href="http://hl7.org/" class="externalLink" title="hl7.org">hl7.org</a></li>
      <li class="pull-right"><a href="https://github.com/hapifhir/hapi-hl7v2" class="externalLink" title="GitHub Project Page">GitHub Project Page</a></li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Welcome</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a>  </li>
    <li><a href="changes-report.html" title="Changelog"><span class="none"></span>Changelog</a>  </li>
    <li><a href="https://smilecdr.com/blog/" class="externalLink" title="Blog"><span class="none"></span>Blog</a>  </li>
          <li class="nav-header">FHIR</li>
    <li><a href="hapi-fhir/" title="HAPI FHIR"><span class="none"></span>HAPI FHIR</a>  </li>
          <li class="nav-header">Tools</li>
    <li><a href="hapi-testpanel/index.html" title="TestPanel"><span class="none"></span>TestPanel</a>  </li>
    <li><a href="hapi-hl7overhttp/index.html" title="HL7 over HTTP"><span class="none"></span>HL7 over HTTP</a>  </li>
    <li><a href="colouriser.html" title="Colouriser"><span class="none"></span>Colouriser</a>  </li>
          <li class="nav-header">Download</li>
    <li><a href="https://sourceforge.net/projects/hl7api/files/hl7api/" class="externalLink" title="Download Java API"><span class="none"></span>Download Java API</a>  </li>
    <li><a href="hapi-testpanel/install.html" title="Download TestPanel"><span class="none"></span>Download TestPanel</a>  </li>
          <li class="nav-header">Documentation</li>
    <li><a href="getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="devbyexample.html" title="HAPI By Example"><span class="none"></span>HAPI By Example</a>  </li>
    <li><a href="base/apidocs/index.html" title="JavaDoc (API core)"><span class="icon-chevron-down"></span>JavaDoc (API core)</a>
      <ul class="nav nav-list">
    <li><a href="v21/apidocs/index.html" title="v2.1 Messages"><span class="none"></span>v2.1 Messages</a>  </li>
    <li><a href="v22/apidocs/index.html" title="v2.2 Messages"><span class="none"></span>v2.2 Messages</a>  </li>
    <li><a href="v23/apidocs/index.html" title="v2.3 Messages"><span class="none"></span>v2.3 Messages</a>  </li>
    <li><a href="v231/apidocs/index.html" title="v2.3.1 Messages"><span class="none"></span>v2.3.1 Messages</a>  </li>
    <li><a href="v24/apidocs/index.html" title="v2.4 Messages"><span class="none"></span>v2.4 Messages</a>  </li>
    <li><a href="v25/apidocs/index.html" title="v2.5 Messages"><span class="none"></span>v2.5 Messages</a>  </li>
    <li><a href="v251/apidocs/index.html" title="v2.5.1 Messages"><span class="none"></span>v2.5.1 Messages</a>  </li>
    <li><a href="v26/apidocs/index.html" title="v2.6 Messages"><span class="none"></span>v2.6 Messages</a>  </li>
    <li><a href="v27/apidocs/index.html" title="v2.7 Messages"><span class="none"></span>v2.7 Messages</a>  </li>
    <li><a href="v28/apidocs/index.html" title="v2.8 Messages"><span class="none"></span>v2.8 Messages</a>  </li>
    <li><a href="v281/apidocs/index.html" title="v2.8.1 Messages"><span class="none"></span>v2.8.1 Messages</a>  </li>
      </ul>
  </li>
    <li><a href="xref/index.html" title="Source XRef"><span class="none"></span>Source XRef</a>  </li>
    <li><a href="hapi-faq.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
    <li><a href="conformance.html" title="Conformance Tools"><span class="none"></span>Conformance Tools</a>  </li>
    <li><a href="hapi-sourcegen/confgen-usage.html" title="Maven Plugins"><span class="none"></span>Maven Plugins</a>  </li>
          <li class="nav-header">Get Help</li>
    <li><a href="mail-lists.html" title="Mailing List"><span class="none"></span>Mailing List</a>  </li>
          <li class="nav-header">Contribute</li>
    <li><a href="building.html" title="Hacking HAPI"><span class="none"></span>Hacking HAPI</a>  </li>
    <li><a href="submissions.html" title="Submitting Code"><span class="none"></span>Submitting Code</a>  </li>
    <li><a href="issue-tracking.html" title="Issue Tracking"><span class="none"></span>Issue Tracking</a>  </li>
    <li><a href="source-repository.html" title="Source Code"><span class="none"></span>Source Code</a>  </li>
          <li class="nav-header">Reports</li>
    <li><a href="team-list.html" title="HAPI Developers"><span class="none"></span>HAPI Developers</a>  </li>
    <li><a href="surefire-report.html" title="Unit Test Report"><span class="none"></span>Unit Test Report</a>  </li>
    <li><a href="taglist.html" title="Source Tag List"><span class="none"></span>Source Tag List</a>  </li>
    <li><a href="cobertura/index.html" title="Cobertura"><span class="none"></span>Cobertura</a>  </li>
    <li><a href="license.html" title="License"><span class="none"></span>License</a>  </li>
          <li class="nav-header">Older Documentation</li>
    <li><a href="parsing.html" title="Parsing Messages"><span class="none"></span>Parsing Messages</a>  </li>
    <li><a href="installation.html" title="Installation"><span class="none"></span>Installation</a>  </li>
    <li><a href="links.html" title="Helpful Links"><span class="none"></span>Helpful Links</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org" title="Built with Maven 2" class="builtBy"><img class="builtBy"  alt="Built with Maven 2" src="images/logos/maven-feather.png"    /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<section>
<h2><a name="Validation_of_HL7_messages"></a>Validation of HL7 messages</h2><section>
<h3><a name="Introduction"></a>Introduction</h3>
<p>HL7 v2.x is a complex flat-file structure that, despite being considered a data standard, is also highly flexible. It is often expected of an HL7 library that non-standard compliant data be accepted and processed without notification to the receiving system of non-compliance.</p>
<p>However, to achieve real interoperability, the HL7 standard should be constrained to reduce the degree of freedom e.g. how to use certain fields or whether to populate optional fields or not. This happens either based on a written specification or in addition as machine-readble conformance profile. In order to check whether HL7 messages actually conform to the defined constraints, message validation is essential.</p></section><section>
<h3><a name="Validation_Rules_and_RuleBindings"></a>Validation Rules and RuleBindings</h3>
<p>The HAPI library offers support for validating HL7 messages by definition of rules that check against constraints on primitive type level, message level, and encoded message level. </p>
<dl>
<dt><a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/PrimitiveTypeRule.html">PrimitiveTypeRule</a></dt>
<dd> A validation rule that applies to primitive types like ID, IS, NM. PrimitiveTypeRules are enforced every time a primitive value is set. </dd>
<dt><a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/MessageRule.html">MessageRule</a></dt>
<dd> A validation rule that applies to a fully populated message object. MessageRules are enforced (depending on runtime configuration) just after an inbound message has been parsed, or just before an outbound message is encoded. </dd></dl>
<dl>
<dt><a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/EncodingRule.html">EncodingRule</a></dt>
<dd> A validation rule that applies to encoded message strings. EncodingRules are intended for criteria that are specific to the encoded form of a message, e.g. &quot;no empty tags in an XML message&quot;. EncodingRules are enforced (depending on runtime configuration) before an inbound message is parsed, or just after an outbound message has been encoded. </dd></dl>
<p>Rules of all types described above are <i>bound</i> to a HL7 version and <i>scoped</i> depending on the rule type. The scope of a <code>PrimitiveTypeRule</code> is (you guessed it!) a primitive type. The scope of a <code>MessageRule</code> is its event type and trigger event (e.g. ADT_A01). The scope of a <code>EncodingRule</code> is its encoding - &quot;XML&quot; or &quot;VB&quot; (vertical bar).</p>
<p>Binding and scope determine which rules are applied to which parts of a certain message.</p>
<p>There is a predefined set of default PrimitiveTypeRules that conform to the HL7 specification for the corresponding types (<a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/impl/DefaultValidation.html">DefaultValidation</a>). This set is used when no other rules have been defined. Other predefined sets are <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/impl/DefaultValidationWithoutTN.html">DefaultValidationWithoutTN</a> and <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/impl/NoValidation.html">NoValidation</a>.</p></section><section>
<h3><a name="ValidationContext"></a>ValidationContext</h3>
<p>A <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/ValidationContext.html">ValidationContext</a> is the place where Rules and RuleBindings are collected. Parsers and Message Validators can be configured with a <code>ValidationContext</code> to enforce validation during parsing, encoding, or on demand. </p></section><section>
<h3><a name="RuleBuilders"></a>RuleBuilders</h3>
<p>In HAPI 2.0 and before, custom validation rules had to be implemented by extending the appropriate rule types, define their bindings, and collect them in a subclass of <code>ValidationContext</code>. This API can be very cumbersome to use, particularly when large sets of rules need to be defined. A new API implementing a Builder pattern allows to define rules in a way that is easy to write and to understand.</p>
<p>As the default rule sets have been re-implemented as well, they serve as a good example. The validation class to be written now extends <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/builder/ValidationRuleBuilder.html">ValidationRuleBuilder</a> instead of <code>ValidationContext</code>:</p>
<div class="source"><pre class="prettyprint">  public class DefaultValidationWithoutTNBuilder extends ValidationRuleBuilder {

        protected void configure() {
                forAllVersions()
                
                        // you can trim the value before validation
                        .primitive(&quot;FT&quot;).trimLeft(maxLength(32000))
                        .primitive(&quot;ST&quot;).trimLeft()
                        .primitive(&quot;TX&quot;).trimRight()
                        
                        // you can apply the same rule to more than one type
                        .primitive(&quot;ID&quot;, &quot;IS&quot;).is(maxLength(200))
                        
                        // you can also accept empty values
                        .primitive(&quot;SI&quot;).is(emptyOr(nonNegativeInteger()))
                        .primitive(&quot;NM&quot;).is(emptyOr(number()))
                        
                        // you can provide a reference to a section in the spec
                        .primitive(&quot;DT&quot;)
                                .refersToSection(&quot;Version 2.5 Section 2.A.21&quot;)
                                .is(emptyOr(date()))
                        .primitive(&quot;TM&quot;)
                                .refersToSection(&quot;Version 2.5 Section 2.A.75&quot;)
                                .is(emptyOr(time()))
                        .primitive(&quot;NULLDT&quot;).is(withdrawn());
                
                forVersion().before(Version.V25)
                        .primitive(&quot;TSComponentOne&quot;)
                                .refersToSection(&quot;Version 2.4 Section 2.9.47&quot;)
                                .is(emptyOr(dateTime()));
                
                forVersion().asOf(Version.V25)
                        .primitive(&quot;TSComponentOne&quot;, &quot;DTM&quot;)
                                .refersToSection(&quot;Version 2.5 Section 2.A.22&quot;)
                                .is(emptyOr(dateTime25()));
        }
  }</pre></div>
<p>To define a custom rule builder, you extend <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/builder/ValidationRuleBuilder.html">ValidationRuleBuilder</a> or a subclass thereof, and implement the <code>configure</code> method.</p>
<p><code>DefaultValidationWithoutTNBuilder</code> defines PrimitiveTypeRules that are either valid for all HL7 v2 versions or for a subset thereof. In this example, the defined rules require the primitive values to not exceed a maximum length, to be numeric, or to follow a certain time or date pattern. Empty values are usually allowed. Optionally you can add a reference to the HL7 specification for documentation.</p>
<p>While the legacy API is still available (although partly deprecated) and used under the hood, the new API is far more expressive and the rule definitions in the example above only take about 25% of the corresponding amount of legacy code.</p>
<p>In order to add your own rules, you can subclass an existing <code>ValidationRuleBuilder</code>:</p>
<div class="source"><pre class="prettyprint">  public class DefaultValidationBuilder extends DefaultValidationWithoutTNBuilder {

        @Override
        protected void configure() {
                super.configure(); // don't forget this!

                forAllVersions()
                        .primitive(&quot;TN&quot;)
                                .refersToSection(&quot;Version 2.4 Section 2.9.45&quot;)
                                .is(emptyOr(usPhoneNumber()));
        }
  }</pre></div>
<p>Now let's add some fictive MessageRules that define expectations towards the existence of patient identifiers (PID-2, PID-3), and forbids all messages of HL7 versions 2.4 and before, providing a custom explanation:</p>
<div class="source"><pre class="prettyprint">  public class MyCustomRuleBuilder extends DefaultValidationBuilder {

        protected void configure() {
        
                super.configure(); // don't forget this!
                
                forVersion(Version.V25)
                        .message(&quot;ADT&quot;, &quot;*&quot;)
                                .description(&quot;custom message rules&quot;)
                                .terser(&quot;PID-2&quot;, empty())
                                .terser(&quot;PID-3&quot;, allOf(maxLength(10), startsWith(&quot;A&quot;)))
                                
                                // you can reuse existing custom rules
                                .test(new MyExistingMessageRule()) 
                        .message(&quot;ORU&quot;, &quot;R01&quot;)
                                .terser(&quot;MSH-9-1&quot;, isEqual(&quot;ORU&quot;));
                
                forVersion(Version.V26)
                        .message(&quot;ADT&quot;, &quot;*&quot;)
                                .terser(&quot;PID-2&quot;, empty())
                                .terser(&quot;PID-3&quot;, allOf(maxLength(10), startsWith(&quot;B&quot;)))
                
                forVersion().before(Version.V25)
                        .message(&quot;*&quot;, &quot;*&quot;)
                                .description(&quot;Old HL7 version not supported!&quot;)
                                .alwaysFails()
        }
  }</pre></div>
<p>Alternatively, if you prefer composition over inheritance, you can simply extend <a class="externalLink" href="http://hl7api.sourceforge.net/base/apidocs/ca/uhn/hl7v2/validation/builder/DelegatingValidationRuleBuilder.html">DelegatingValidationRuleBuilder</a> :</p>
<div class="source"><pre class="prettyprint">  public class MyCustomRuleBuilder extends DelegatingValidationRuleBuilder {

        public MyCustomRuleBuilder() {
                super(new DefaultValidationBuilder())
        }
        
        protected void configure() {
                // ... same as above
        }
  }</pre></div></section></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2001&#x2013;2023
<a href="http://www.uhn.ca">University Health Network</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
